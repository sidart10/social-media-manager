{
  "url": "https://www.promptingguide.ai/agents/context-engineering-deep-dive",
  "title": "Context Engineering Deep Dive: Building a Deep Research Agent",
  "content": "Context engineering (opens in a new tab) requires significant iteration and careful design decisions to build reliable AI agents. This guide takes a deep dive into the practical aspects of context engineering through the development of a basic deep research agent, exploring some of the techniques and design patterns that improve agent reliability and performance.\n\nThis content is based on our new course \"Building Effective AI Agents with n8n\" (opens in a new tab), which provides comprehensive insights, downloadable templates, prompts, and advanced tips into designing and implementing agentic systems.\n\nBuilding effective AI agents requires substantial tuning of system prompts and tool definitions. The process involves spending hours iterating on:\n\nDon't underestimate the effort required for context engineering. It's not a one-time task but an iterative process that significantly impacts agent reliability and performance.\n\nLet's look at a basic deep research agent architecture. The initial architecture connects the web search tool directly to the deep research agent. This design places too much burden on a single agent responsible for:\n\nConsequences of this design:\n\nThe solution involved separating concerns by introducing a dedicated search worker agent:\n\nBenefits of the multi-agent design:\n\nIf you are using models from other providers like OpenAI, you can leverage GPT-5 (for planning and reasoning) and GPT-5-mini (for search execution) for similar performance.\n\nDesign Principle: Separating agent responsibilities improves reliability and enables cost-effective model selection for different subtasks.\n\nHere is the full system prompt for the deep research agent we built in n8n:\n\nLet's break it down into parts and discuss why each section is important:\n\nThe system prompt begins with a clear definition of the agent's role:\n\nProvide explicit instructions about the agent's workflow:\n\nCurrent Date Information:\n\nIncluding the current date is crucial for research agents to get up-to-date information:\n\nIn n8n, you can dynamically inject the current date using built-in functions with customizable formats (date only, date with time, specific timezones, etc.).\n\nTool definitions typically appear in two places:\n\nKey Insight: The biggest performance improvements often come from clearly explaining tool usage in the system prompt, not just defining tool parameters.\n\nThe system prompt also includes detailed instructions for using the available tools:\n\nInitially, without explicit status definitions, the agent would use different status values across runs:\n\nBe explicit about allowed values. This eliminates ambiguity and ensures consistent behavior.\n\nNote that the system prompt also includes this instruction:\n\nWhat's the reasoning behind this decision?\n\nThis provides flexibility for the agent to optimize its execution strategy. During testing, the agent might:\n\nHere is a specific instruction you can use, if you require all search tasks to be executed:\n\nWhen to use flexible vs. rigid approaches:\n\nContext engineering is not a one-time effort. The development process involves:\n\nEven after multiple iterations, there are opportunities for further improvement:\n\nSearch Task Metadata:\n\nEnhanced Search Planning:\n\nDate Range Specification:\n\nBased on the recommended improvements, it's easy to appreciate that web search for AI agents is a challenging effort that requires a lot of context engineering.\n\nWhen designing multi-agent systems, carefully consider:\n\nWhat information does the sub-agent need?\n\nWhat information should the sub-agent return?\n\nAs agents execute multiple tasks, context grows:\n\nStrategies to manage context length:\n\nInclude instructions for failure scenarios:\n\nContext engineering is a critical practice for building reliable AI agents that requires:\n\nThe deep research agent example demonstrates how thoughtful context engineering transforms an unreliable prototype into a robust, production-ready system. By applying these principles—clear role definitions, explicit tool instructions, essential context provision, and iterative improvement—you can build AI agents that consistently deliver high-quality results.\n\nLearn how to build production-ready AI agents with hands-on examples and templates. Join our comprehensive course! (opens in a new tab) Use code PROMPTING20 to get an extra 20% off.",
  "headings": [
    {
      "level": "h1",
      "text": "Context Engineering Deep Dive: Building a Deep Research Agent",
      "id": ""
    },
    {
      "level": "h2",
      "text": "The Reality of Context Engineering",
      "id": ""
    },
    {
      "level": "h2",
      "text": "Agent Architecture Design",
      "id": ""
    },
    {
      "level": "h3",
      "text": "The Original Design Problem",
      "id": ""
    },
    {
      "level": "h3",
      "text": "The Improved Multi-Agent Architecture",
      "id": ""
    },
    {
      "level": "h2",
      "text": "System Prompt Engineering",
      "id": ""
    },
    {
      "level": "h3",
      "text": "High-Level Agent Definition",
      "id": ""
    },
    {
      "level": "h3",
      "text": "General Instructions",
      "id": ""
    },
    {
      "level": "h3",
      "text": "Providing Essential Context",
      "id": ""
    },
    {
      "level": "h2",
      "text": "Tool Definitions and Usage Instructions",
      "id": ""
    },
    {
      "level": "h3",
      "text": "The Importance of Detailed Tool Descriptions",
      "id": ""
    },
    {
      "level": "h3",
      "text": "Example Tool Instructions",
      "id": ""
    },
    {
      "level": "h2",
      "text": "Context Engineering Iteration Process",
      "id": ""
    },
    {
      "level": "h3",
      "text": "The Iterative Nature of Improving Context",
      "id": ""
    },
    {
      "level": "h3",
      "text": "What's Still Missing",
      "id": ""
    },
    {
      "level": "h2",
      "text": "Advanced Considerations",
      "id": ""
    },
    {
      "level": "h3",
      "text": "Sub-Agent Communication",
      "id": ""
    },
    {
      "level": "h3",
      "text": "Context Length Management",
      "id": ""
    },
    {
      "level": "h3",
      "text": "Error Handling in System Prompts",
      "id": ""
    },
    {
      "level": "h2",
      "text": "Conclusion",
      "id": ""
    }
  ],
  "code_samples": [
    {
      "code": "You are a deep research agent who will help with planning and executing search tasks to generate a deep research report.\n \n## GENERAL INSTRUCTIONS\n \nThe user will provide a query, and you will convert that query into a search plan with multiple search tasks (3 web searches). You will execute each search task and maintain the status of those searches in a spreadsheet.\n \nYou will then generate a final deep research report for the user.\n \nFor context, today's date is: {{ $now.format('yyyy-MM-dd') }}\n \n## TOOL DESCRIPTIONS\n \nBelow are some useful instructions for how to use the available tools. \n \nDeleting tasks: Use the delete_task tool to clear up all the tasks before starting the search plan. \n \nPlanning tasks: You will create a plan with the search tasks (3 web searches) and add them to the Google Sheet using the append_update_task tool. Make sure to keep the status of each task updated after completing each search. Each task begins with a todo status and will be updated to a \"done\" status once the search worker returns information regarding the search task.\n \nExecuting tasks: Use the Search Worker Agent tool to execute the search plan. The input to the agent are the actual search queries, word for word. \n \nUse the tools in the order that makes the most sense to you but be efficient.",
      "language": "unknown"
    },
    {
      "code": "You are a deep research agent who will help with planning and executing search tasks to generate a deep research report.",
      "language": "unknown"
    },
    {
      "code": "## GENERAL INSTRUCTIONS\n \nThe user will provide a query, and you will convert that query into a search plan with multiple search tasks (3 web searches). You will execute each search task and maintain the status of those searches in a spreadsheet.\n \nYou will then generate a final deep research report for the user.",
      "language": "unknown"
    },
    {
      "code": "For context, today's date is: {{ $now.format('yyyy-MM-dd') }}",
      "language": "unknown"
    },
    {
      "code": "## TOOL DESCRIPTIONS\n \nBelow are some useful instructions for how to use the available tools. \n \nDeleting tasks: Use the delete_task tool to clear up all the tasks before starting the search plan. \n \nPlanning tasks: You will create a plan with the search tasks (3 web searches) and add them to the Google Sheet using the append_update_task tool. Make sure to keep the status of each task updated after completing each search. Each task begins with a todo status and will be updated to a \"done\" status once the search worker returns information regarding the search task.\n \nExecuting tasks: Use the Search Worker Agent tool to execute the search plan. The input to the agent are the actual search queries, word for word. \n \nUse the tools in the order that makes the most sense to you but be efficient.",
      "language": "unknown"
    },
    {
      "code": "Use the tools in the order that makes most sense to you, but be efficient.",
      "language": "unknown"
    },
    {
      "code": "You MUST execute a web search for each and every search task you create.\nDo NOT skip any tasks, even if they seem redundant.",
      "language": "unknown"
    },
    {
      "code": "ERROR HANDLING:\n- If search_worker fails, retry once with rephrased query\n- If task cannot be completed, mark status as \"failed\" with reason\n- If critical errors occur, notify user and request guidance\n- Never proceed silently when operations fail",
      "language": "unknown"
    }
  ],
  "patterns": [],
  "links": [
    "https://www.promptingguide.ai/agents/context-engineering-deep-dive"
  ]
}