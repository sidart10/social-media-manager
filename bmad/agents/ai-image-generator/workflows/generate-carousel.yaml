# Generate Carousel Workflow
# Purpose: Create 2-10 image carousel sets for social media
# Status: PRODUCTION READY v2.0 - Skills Integration Complete

name: generate-carousel
description: "Generate professional carousel image sets using create-image skill with Emily's JSON methodology, intelligent tool selection, and 7-pillar quality framework"
author: "AI Image Generator Agent"
version: "2.0.0"

# Standard BMAD v6 Config Block
config_source: "{project-root}/bmad/agents/ai-image-generator/config.yaml"
output_folder: "{config_source}:output_folder"
user_name: "{config_source}:user_name"
communication_language: "{config_source}:communication_language"
date: system-generated

# Module-Specific Paths
sidecar_config: "{config_source}:sidecar_config"
capabilities_doc: "{config_source}:capabilities_doc"
best_practices_doc: "{config_source}:best_practices_doc"
template_folder: "{config_source}:templates_folder"
outputs_folder: "{config_source}:outputs_folder"
skills_folder: "{config_source}:skills_folder"

# This is an action workflow (no template document)
template: false

# Instructions
instructions:
  - step: 1
    goal: "Gather carousel requirements from user"

    <ask>What's your carousel topic or theme?</ask>

    <action>Store user response as {{topic}}</action>

    <ask>How many slides do you need? (2-10 recommended for carousels)</ask>

    <action>Store as {{slide_count}} and validate it's between 2-10</action>

    <check if="slide_count < 2 or slide_count > 10">
      <action>Warn user: "Carousels work best with 2-10 slides. Instagram allows max 10."</action>
      <ask>Proceed anyway or adjust? [proceed/adjust]</ask>
    </check>

    <ask>Which design style?
    1. LinkedIn - Dark professional tech (monochrome, Inter font, data-driven) ‚≠ê
    2. YouTube - Eye-catching thumbnails (bold text, vibrant, high CTR) üé¨
    3. Instagram - Vibrant engaging (coming soon)
    4. Twitter - Bold concise (coming soon)
    5. Custom - Define your own
    </ask>

    <action>Store as {{design_choice}}</action>

    <action>Map design to platform:</action>
    <check if="design_choice == 1">
      <action>platform = "LinkedIn"</action>
      <action>design_system = "linkedin-design"</action>
      <action>Note: linkedin-design skill will auto-load with dark tech aesthetic, captions, best practices</action>
    </check>
    <check if="design_choice == 2">
      <action>platform = "YouTube"</action>
      <action>design_system = "youtube-thumbnail-design"</action>
      <action>Note: youtube-thumbnail-design skill will auto-load with thumbnail best practices</action>
      <action>Note: For YouTube, carousel = multiple thumbnail variations for A/B testing</action>
    </check>
    <check if="design_choice == 3">
      <action>platform = "Instagram"</action>
      <action>design_system = "vibrant-social"</action>
      <action>Note: Using generic Instagram specs (instagram-design skill coming soon)</action>
    </check>
    <check if="design_choice == 4">
      <action>platform = "Twitter"</action>
      <action>design_system = "bold-concise"</action>
      <action>Note: Using generic Twitter specs (twitter-design skill coming soon)</action>
    </check>
    <check if="design_choice == 5">
      <action>platform = "Custom"</action>
      <action>design_system = "custom"</action>
    </check>

    <action>Store platform as {{platform}}</action>
    <action>Store design_system as {{design_system}}</action>

    <ask>Do you have an existing template to use, or should I create one?
    1. Use existing template
    2. Create new template from scratch
    </ask>

    <action>Store response as {{template_choice}}</action>

  - step: 2
    goal: "Load or create template"

    <check if="template_choice == use existing">
      <action>List available templates from {{template_folder}}:</action>
      <action>- TEST-linkedin-carousel-ai-agents.json (AI/tech diagrams, dark design)</action>
      <action>- linkedin-carousel-ai-browsers.json (Product showcases)</action>
      <ask>Which template? Or provide filename:</ask>
      <action>Read template file using Read tool</action>
      <action>Store as {{template}}</action>
    </check>

    <check if="template_choice == create new">
      <action>Create template based on user requirements</action>
      <action>Apply design system (dark monochrome tech for LinkedIn, lighter for Instagram)</action>
      <action>Structure {{slide_count}} slides with proper prompts</action>
      <action>Include negative prompts</action>
      <action>Set aspect ratio based on platform</action>
      <action>Store as {{template}}</action>
      <ask>Save this template for reuse? [y/n]</ask>
      <check if="user says yes">
        <ask>Template filename?</ask>
        <action>Write template to templates/ folder</action>
      </check>
    </check>

    <action>Parse template JSON and extract:</action>
    <action>- aspect_ratio from platform_specs</action>
    <action>- slide count from slides array</action>
    <action>- design_system details</action>
    <action>- provider_routing recommendation</action>

  - step: 3
    goal: "Validate specifications and confirm with user"

    <action>Map aspect_ratio to supported OpenAI size:</action>
    <action>- If "1:1" ‚Üí 1024x1024</action>
    <action>- If "16:9" ‚Üí 1536x1024 (actually 3:2, closest match)</action>
    <action>- If "9:16" ‚Üí 1024x1536 (actually 2:3, closest match)</action>
    <action>- If "4:5" ‚Üí 1024x1536</action>
    <action>- If "2:3" ‚Üí 1024x1536</action>
    <action>Store as {{validated_size}}</action>

    <action>Display generation summary:</action>
    <action>
    Ready to generate carousel:

    Topic: {{topic}}
    Slides: {{slide_count}}
    Platform: {{platform}}
    Size: {{validated_size}} ({{aspect_ratio}})
    Design: {{design_system.aesthetic}}
    Provider: {{provider_routing.recommended_provider}}
    Est. Time: {{slide_count √ó 3}} seconds (~{{slide_count √ó 3 / 60}} minutes)

    Output: outputs/{{topic_slug}}/
    </action>

    <ask>Proceed with generation? [y/n]</ask>

    <check if="user says no">
      <ask>What would you like to adjust?</ask>
      <goto step="1">Return to requirements</goto>
    </check>

  - step: 4
    goal: "Prepare output folder and load API config"

    <action>Create topic slug from {{topic}}: lowercase, replace spaces with hyphens</action>
    <action>Store as {{topic_slug}}</action>

    <action>Create output folder using Bash tool:</action>
    <action>Bash: mkdir -p "{{outputs_folder}}/{{topic_slug}}"</action>

    <action>Load config.yaml to verify API keys exist</action>
    <action>Read: {{config_source}}</action>

    <action>Note: MCP tools will use API keys from ~/.claude.json automatically</action>

# Skills context: create-image skill auto-loads for carousel generation
# Provides: Emily's JSON methodology, platform-appropriate design systems, tool selection

  - step: 5
    goal: "Generate each slide via MCP"

    <action>Initialize: current_slide = 0</action>

    <for-each>slide in template.slides</for-each>

    <action>Increment: current_slide += 1</action>

    <action>Show progress: "üé® Generating Slide {{current_slide}} of {{slide_count}}..."</action>

    <action>Extract slide data from template:</action>
    <action>- prompt_text = slide.prompt</action>
    <action>- negative_text = slide.negative_prompt OR template.global_negative_prompt</action>
    <action>- theme_color = slide.theme_color (if exists)</action>

    <action>Construct complete prompt for this slide:</action>
    <action>If negative_text exists: full_prompt = prompt_text + " Avoid: " + join(negative_text, ", ")</action>
    <action>Else: full_prompt = prompt_text</action>
    <action>Store as {{full_prompt}}</action>

    <action>Select MCP tool based on platform:</action>
    <check if="platform == LinkedIn OR platform == Twitter">
      <action>Use: gpt-image-1 (professional quality + text rendering)</action>
      <action>Store as {{selected_tool}}</action>
    </check>
    <check if="platform == Instagram">
      <action>Use: nanobanana (speed + cost for volume)</action>
      <action>Store as {{selected_tool}}</action>
    </check>
    <action>Default: gpt-image-1</action>

    <action>Record start_time</action>

    <critical>Generate image via MCP:</critical>
    <check if="selected_tool == gpt-image-1">
      <action>
      Tool: mcp__gpt-image-1__create_image
      Parameters:
        prompt: {{full_prompt}}
        size: {{validated_size}}
        quality: "high"
        output_format: "png"
        n: 1

      Store result as {{mcp_result}}
      </action>
    </check>
    <check if="selected_tool == nanobanana">
      <action>
      Tool: mcp__nanobanana__generate_image
      Parameters:
        prompt: {{full_prompt}}
        mode: "generate"
        negative_prompt: {{negative_text}}
        n: 1

      Store result as {{mcp_result}}
      </action>
    </check>

    <action>Record end_time and calculate generation_time_seconds</action>

    <action>Extract file_path from mcp_result</action>
    <action>Store as {{mcp_file_path}}</action>

    <action>Copy from MCP location to agent outputs:</action>
    <action>Bash: cp "{{mcp_file_path}}" "{{outputs_folder}}/{{topic_slug}}/slide{{current_slide}}.png"</action>

    <action>Get file size using Bash:</action>
    <action>Bash: ls -lh "{{outputs_folder}}/{{topic_slug}}/slide{{current_slide}}.png" | awk '{print $5}'</action>
    <action>Store as {{file_size}}</action>

    <action>Create metadata JSON using Write tool:</action>
    <action>
    Write: {{outputs_folder}}/{{topic_slug}}/slide{{current_slide}}_metadata.json
    Content: {
      "slide_number": current_slide,
      "template_used": template_filename,
      "topic": topic,
      "prompt_full": full_prompt,
      "provider": selected_tool,
      "skill_used": "create-image",
      "methodology": "Emily's JSON framework",
      "size": validated_size,
      "aspect_ratio_requested": aspect_ratio,
      "aspect_ratio_actual": "3:2" or "1:1" or "2:3",
      "quality": "high",
      "output_format": "png",
      "timestamp": ISO-8601 timestamp,
      "generation_time_seconds": generation_time_seconds,
      "file_path_mcp": mcp_file_path,
      "file_path_agent": relative path to slide,
      "file_size": file_size,
      "theme_color": theme_color,
      "design_system": design_system name,
      "platform": platform,
      "quality_score": {
        "clarity": 0,
        "technical_quality": 0,
        "composition": 0,
        "color_accuracy": 0,
        "typography": 0,
        "professionalism": 0,
        "prompt_accuracy": 0,
        "overall": 0,
        "reviewed": false,
        "notes": "Use 7-pillar evaluation from create-image skill"
      }
    }
    </action>

    <action>Show completion: "‚úÖ Slide {{current_slide}} complete! ({{file_size}})"</action>

    <template-output>slide_{{current_slide}}_complete</template-output>

  - step: 6
    goal: "Create carousel summary document"

    <action>Calculate total_file_size and total_generation_time</action>

    <action>Create CAROUSEL_SUMMARY.md using Write tool:</action>
    <action>
    Content:
    # {{topic}} - Carousel Summary

    Generated: {{timestamp}}
    Topic: {{topic}}
    Slides: {{slide_count}}
    Platform: {{platform}}
    Design: {{design_system.aesthetic}}

    ## Files Generated
    {{list all slide files with sizes}}

    Total Size: {{total_file_size}}MB
    Generation Time: {{total_generation_time}} seconds

    ## Specifications
    - Size: {{validated_size}}
    - Aspect Ratio: {{aspect_ratio}}
    - Quality: High
    - Provider: {{provider}}
    - Format: PNG

    ## Next Steps
    1. Review slides visually
    2. Run quality critique
    3. Post to {{platform}}

    Location: {{outputs_folder}}/{{topic_slug}}/
    </action>

    <action>Write summary to: {{outputs_folder}}/{{topic_slug}}/CAROUSEL_SUMMARY.md</action>

  - step: 7
    goal: "Present results and offer next actions"

    <action>Display completion message:</action>
    <action>
    üéâ Carousel Generation Complete!

    Generated {{slide_count}} slides in {{total_generation_time}} seconds.

    Files:
    {{list each slide with filename and size}}

    Location: {{outputs_folder}}/{{topic_slug}}/

    Total Size: {{total_file_size}}MB
    </action>

    <action>List generated files using Bash:</action>
    <action>Bash: ls -lh "{{outputs_folder}}/{{topic_slug}}/"</action>

    <ask>What would you like to do next?
    1. Review slides and run quality critique
    2. Regenerate specific slides
    3. Generate captions for posting
    4. Create another carousel
    5. Exit
    </ask>

    <check if="option 1 selected">
      <action>For each slide, offer to display and score</action>
      <ask>Score this slide using 7-pillar quality framework? [y/n]</ask>
      <check if="yes">
        <action>Prompt user to review slide visually</action>
        <ask>Clarity (1-10): Message understood in <3 seconds?</ask>
        <ask>Technical Quality (1-10): Sharp, no artifacts?</ask>
        <ask>Composition (1-10): Good balance, hierarchy?</ask>
        <ask>Color Accuracy (1-10): Matches template palette?</ask>
        <ask>Typography (1-10): Legible, proper hierarchy?</ask>
        <ask>Professionalism (1-10): Enterprise-grade?</ask>
        <ask>Prompt Accuracy (1-10): All elements present?</ask>
        <action>Calculate overall score (average)</action>
        <action>Update metadata JSON with scores</action>
        <check if="overall < 7">
          <action>Recommend refinements based on low scores</action>
          <ask>Regenerate this slide with improvements? [y/n]</ask>
        </check>
      </check>
    </check>

    <check if="option 2 selected">
      <ask>Which slide number to regenerate?</ask>
      <ask>What should I change in the prompt?</ask>
      <action>Load slide metadata</action>
      <action>Update prompt with changes</action>
      <goto step="5">Regenerate specific slide</goto>
    </check>

    <check if="option 3 selected">
      <action>For each slide, generate platform-appropriate caption</action>
      <action>Generate accessibility alt-text</action>
      <action>Suggest hashtags based on topic</action>
      <action>Save to CAPTIONS.md in carousel folder</action>
    </check>

    <check if="option 4 selected">
      <goto step="1">Start new carousel</goto>
    </check>

# Validation checklist
validation:
  required_outputs:
    - "{{slide_count}} PNG files"
    - "{{slide_count}} metadata JSON files"
    - "CAROUSEL_SUMMARY.md"

  quality_checks:
    - "All files saved successfully"
    - "File sizes reasonable (1-2MB each)"
    - "Metadata complete for each slide"
    - "Topic folder organized"

  workflow_checks:
    - "Template loaded/created"
    - "MCP tool responded"
    - "All slides generated"
    - "No errors in metadata"
    - "Summary document created"

# Notes
notes: |
  This workflow uses MCP tools for 30x faster generation (3 sec vs 90 sec per image).

  MCP saves to default locations:
  - OpenAI: ~/Pictures/gpt-image-1/gpt-images/
  - Nanobanana: ~/nanobanana-images/

  Workflow copies files to agent outputs/ folder for organization.

  Metadata JSON enables reproducibility and quality tracking.
